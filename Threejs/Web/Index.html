<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Unity </title>
</head>
<body>
<script type="module">
   // import * as threejs from "../build/three.js";
    import * as THREE from "../build/three.module.js";
    import { OrbitControls } from './OrbitControls.js';
    import {BundleLoader} from "../Loader/BundleLoader.js";
    import {ObjectLoader} from "../Loader/ObjectLoader.js";

    var renderer,camera,scene;
    var geometry;
    init();
    animate();

    function init(){
        renderer = new THREE.WebGLRenderer();
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.body.appendChild( renderer.domElement );

        camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 2000 );
        camera.position.set( 0, 0, -10 );
        camera.lookAt( 0, 0, 0 );

        scene = new THREE.Scene();

        let ambientLight = new THREE.AmbientLight( 0x333333 );	// 0.2
        let light = new THREE.DirectionalLight( 0xFFFFFF, 1.0 );
        scene.add(ambientLight);
        scene.add(light);


        var geometry = new THREE.SphereGeometry( 0.5, 32, 32 );
        var material = new THREE.MeshStandardMaterial( {color: 0xffff00} );
        material.metalness = 1;
        var sphere = new THREE.Mesh( geometry, material );
        sphere.castShadow = true; //default is false
        sphere.receiveShadow = false; //default
        scene.add( sphere );

        // var helper = new THREE.CameraHelper( light.shadow.camera );
        // scene.add( helper );


        window.addEventListener( 'resize', onWindowResize, false );

        var controls = new OrbitControls( camera, renderer.domElement );
        //controls.maxPolarAngle = Math.PI * 0.5;
        controls.minDistance = 0;
        controls.maxDistance = 5000;

        var loader = new ObjectLoader();
        loader.setParent(scene);
        loader.load("../assets/SampleScene.scene", function (_) {

        });

        //var mesh = new THREE.Mesh(new THREE.CubeGeometry(2,2), new THREE.MeshBasicMaterial());
       // scene.add(mesh);
       // downFile();
    }

    function downFile() {
        let xhr = new XMLHttpRequest();
        xhr.open('GET', "../assets/0000000000000000e000000000000000_Cube");
        xhr.responseType = 'arraybuffer';

        xhr.onload = function () {
            let arrayBuffer = xhr.response;
            let length = new Int32Array(arrayBuffer, 0, 1)[0];
            let headView = new DataView(arrayBuffer, 4,length*4*4);
            console.log(headView);

            let fileData = new Map();

            for (let i = 0; i < length;i++){

                let id = headView.getInt32(i*4*4,true);
                let dataType = headView.getInt32(i*4*4+4,true);
                let offset = headView.getInt32(i*4*4+8,true);
                let byteLength = headView.getInt32(i*4*4+12,true);
                console.log(id,dataType,offset,byteLength);
                fileData.set(id, arrayBuffer.slice(offset, offset+byteLength));// new Int8Array(arrayBuffer,offset, byteLength);
            }


            let geometry = new THREE.BufferGeometry();
            let vertices = new Float32Array(fileData.get(0));
            console.log(fileData);
            geometry.setIndex( [...new Int32Array(fileData.get(1))]);
            geometry.setAttribute( 'position', new THREE.BufferAttribute( vertices, 3 ) );

            let material = new THREE.MeshBasicMaterial( { color: 0xff9900 } );
            let mesh = new THREE.Mesh( geometry, material );
            scene.add( mesh );

        };

        xhr.send();
    }




    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize( window.innerWidth, window.innerHeight );

    }

    function animate(){
        requestAnimationFrame( animate );
        //console.log(camera.position);
        renderer.render( scene, camera );
    }

</script>
</body>
</html>